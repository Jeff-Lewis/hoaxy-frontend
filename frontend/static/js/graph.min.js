function HoaxyGraph(e){var t={},n=(e.spinStart,e.spinStop||function(){console.log("HoaxyGraph.spinStop is undefined.")}),o=e.toggle_edge_modal||function(){console.log("HoaxyGraph.toggle_edge_modal is undefined.")},i=e.toggle_node_modal||function(){console.log("HoaxyGraph.toggle_node_modal is undefined.")},r=e.node_modal_content||{},s=e.edge_modal_content||{},a=(e.twitter_account_info,e.spinner_notices||{}),c=e.twitter||null,u=e.getting_bot_scores||!1,d=e.graphAnimation||{playing:!1,increment:0,total_increments:40},_=e.twitterRateLimitReached,g="",l={start_time:0,end_time:0},m={user_list:[],current_index:0,total:0,found:0,old:0,unavailable:0,reset:function(){this.total=this.found=this.old=this.unavailable=0},recompute:function(){for(var e in this.found=this.old=this.unavailable=0,v)if(this.user_list.indexOf(e)>-1){var t=v[e];-1===t.score?this.unavailable+=1:!0===t.old?(this.old+=1,this.found+=1):this.found+=1}this.total=this.user_list.length}},h=null,f={},p=[],w=[],v={},b=0;var y=0;var x=0;function S(e){function t(){v[e.user_id]={score:-1,old:!0},A(e.user_id,v[e.user_id].score),m.recompute()}return new Promise(function(n,o){(e.score&&(A(e.user_id,e.score),n()),!e.score||e.old)&&function(e){var t={},n=h.graph.nodes(e).data.screenName;return botScoreA=new Promise(function(o,i){var s=new Promise(function(n,o){c.getUserDataById(e).then(function(e){t.user=e,c.getUserMentions(t.user.screen_name).then(function(e){e.statuses?t.mentions=e.statuses:t.mentions=e,n()},function(){}).catch(z)},function(){}).catch(z)},function(){}).catch(z),a=c.getUserTimelineById(e);a.then(function(e){t.timeline=e},function(){}).catch(z),Promise.all([s,a]).then(function(e){(function(e,t){var n=e.user.screen_name,o=e.user.id_str;console.debug(e);var i=axios({method:"post",url:configuration.botometer_url,headers:configuration.botometer_headers,responseType:"json",data:e});return i.then(function(e){var i=e.data.user.id_str,s=0;if("en"==g||"en-gb"==g?s=e.data.scores.english:(console.log("hit universal: "+e.data.scores),s=e.data.scores.universal),t!=e.data.user.screen_name)var a=t,c=e.data.user.screen_name,u=!0;else a=t,c="unchanged",u=!1;var d=Math.round(100*e.data.cap.english);r.staleAcctInfo.newId=i,r.staleAcctInfo.oldSn=a,r.staleAcctInfo.newSn=c,r.staleAcctInfo.isStale=u,r.completeAutomationProbability=d,v[o]={score:s,old:!1,time:new Date,user_id:e.data.user.id,screen_name:n,completeAutomationProbability:d,staleAcctInfo:{isStale:u,newId:i,oldSn:a,newSn:c}},r.showStaleContent=!0,A(o,v[o].score)},function(e){console.debug("Could not get bot score for "+n+": ",e)}),i})(t,n).then(o,i)},function(e){console.warn("Could not get bot score for "+n+": ",e),i(e)})},z),botScoreA}(e.user_id).then(function(e){m.recompute(),n(e)},function(e){e.error&&429==e.error.status?o("Error: rate limit reached"):(t(),o())})}).then(function(e){return e},function(e){return e})}function z(e){console.warn(e)}function A(e,t){(color=q(t),h&&h.graph)&&(h.graph.nodes(e)&&(h.graph.nodes(e).color=color,h.graph.nodes(e).borderColor=C(t),T()))}var I=0;function T(){clearTimeout(I),I=setTimeout(function(){h.refresh({skipIndexation:!0})},100)}function N(e){if(null==e)return colors.node_colors.fact_checking;if(!1===e)return{r:255,g:255,b:255};if(e<0)return{r:230,g:230,b:230};e*=100;var t=colors.node_colors.botscores;var n={};return(n=e<20?t[4]:e<40?t[3]:e<60?t[2]:e<80?t[1]:t[0]).r=n.red,n.g=n.green,n.b=n.blue,n}function q(e){var t=N(e);return"rgb("+t.r+", "+t.g+", "+t.b+")"}function C(e){var t=120;!1===e&&(t=50);var n=N(e);return n.r=n.r-t,n.r<0&&(n.r=0),n.g=n.g-t,n.g<0&&(n.g=0),n.b=n.b-t,n.b<0&&(n.b=0),"rgb("+n.r+", "+n.g+", "+n.b+")"}function M(){h&&(h.kill(),h=null),document.getElementById("graph-container").innerHTML=""}function k(){b++,h=new sigma({graph:f,container:"graph-container",renderer:{container:document.getElementById("graph-container"),type:"canvas"},settings:{autoRescale:!0,scalingMode:"inside",edgeHoverExtremities:!0,borderSize:1,minArrowSize:6,labelThreshold:8,enableEdgeHovering:!0,edgeHoverSizeRatio:2,singleHover:!0,rescaleIgnoreSize:!0,defaultNodeType:"border",zoomingRatio:1.2}});var e=600*Math.floor(Math.sqrt(f.edges.length));for(var t in h.refresh({skipIndexation:!0}),h.startForceAtlas2({slowDown:100,gravity:2}),v)A(t,v[t].score);n("generateNetwork"),setTimeout(function(){b<2?(h.stopForceAtlas2(),h.camera.goTo({x:0,y:0,ratio:1}),n("ForceAtlas"),a.graph="",b--):b--},2e3+e),h.bind("clickNode",function(e){var t=e.data.node.data;r.user_id=e.data.node.id,r.screenName=t.screenName,r.staleAcctInfo.openedModalWhileFetchingScores=u.running;var n=!1;if(v[t.id]){v[t.id];n=v[t.id].score,n=Math.floor(100*n),r.botcolor=0!=n?q(n/100):"",r.botscore=n,r.timestamp=v[t.id].time,v[t.id].hasOwnProperty("staleAcctInfo")&&v[t.id].hasOwnProperty("completeAutomationProbability")?(r.staleAcctInfo.isStale=v[t.id].staleAcctInfo.isStale,r.staleAcctInfo.newId=v[t.id].staleAcctInfo.newId,r.staleAcctInfo.oldSn=v[t.id].staleAcctInfo.oldSn,r.staleAcctInfo.newSn=v[t.id].staleAcctInfo.newSn,r.completeAutomationProbability=v[t.id].completeAutomationProbability,r.showStaleContent=!0):r.showStaleContent=!1}else r.showStaleContent=!1,r.botscore=!1,r.botcolor="";!function(e){var t=e.data.node.data,n={is_mentioned_by:{},has_quoted:{},has_retweeted:{},has_mentioned:{},is_quoted_by:{},is_retweeted_by:{}},o={is_mentioned_by_count:0,has_quoted_count:0,has_retweeted_count:0,has_mentioned_count:0,is_quoted_by_count:0,is_retweeted_by_count:0};for(var i in t.incoming){var s="https://twitter.com/intent/user?user_id="+String(i),a="https://twitter.com/intent/user?user_id="+e.data.node.id;for(var c in t.incoming[i].ids){var u=TWEET_URL.replace("%0",i).replace("%1",t.incoming[i].ids[c]);1!=t.incoming[i].is_mentions[c]&&0!=t.incoming[i].is_mentions[c]&&console.log("GenerateUserModal Parse incoming.is_mentions error!!");var d="";1==t.incoming[i].is_mentions[c]||"reply"==t.incoming[i].tweet_types[c]?d="is_mentioned_by":"quote"==t.incoming[i].tweet_types[c]?d="has_quoted":"retweet"==t.incoming[i].tweet_types[c]&&(d="has_retweeted"),n[d][i]=n[d][i]||{user_url:s,screenName:t.incoming[i].screenName,article_titles:[],tweet_urls:[],article_urls:[]},n[d][i].article_titles.push(t.incoming[i].titles[c]),n[d][i].tweet_urls.push(u),n[d][i].article_urls.push(t.incoming[i].url_raws[c]),o[d+"_count"]++}}for(var i in t.outgoing)for(var c in s="https://twitter.com/intent/user?user_id="+e.data.node.id,a="https://twitter.com/intent/user?user_id="+String(i),t.outgoing[i].ids)u=TWEET_URL.replace("%0",i).replace("%1",t.outgoing[i].ids[c]),1!=t.outgoing[i].is_mentions[c]&&0!=t.outgoing[i].is_mentions[c]&&console.log("GenerateUserModal Parse outgoing.is_mentions error!!"),d="",1==t.outgoing[i].is_mentions[c]||"reply"==t.outgoing[i].tweet_types[c]?d="has_mentioned":"quote"==t.outgoing[i].tweet_types[c]?d="is_quoted_by":"retweet"==t.outgoing[i].tweet_types[c]&&(d="is_retweeted_by"),n[d][i]=n[d][i]||{user_url:a,screenName:t.outgoing[i].screenName,article_titles:[],tweet_urls:[],article_urls:[]},n[d][i].article_titles.push(t.outgoing[i].titles[c]),n[d][i].tweet_urls.push(u),n[d][i].article_urls.push(t.outgoing[i].url_raws[c]),o[d+"_count"]++;r.is_mentioned_by=n.is_mentioned_by,r.has_quoted=n.has_quoted,r.has_retweeted=n.has_retweeted,r.has_mentioned=n.has_mentioned,r.is_quoted_by=n.is_quoted_by,r.is_retweeted_by=n.is_retweeted_by,r.is_mentioned_by_count=o.is_mentioned_by_count,r.has_quoted_count=o.has_quoted_count,r.has_retweeted_count=o.has_retweeted_count,r.has_mentioned_count=o.has_mentioned_count,r.is_quoted_by_count=o.is_quoted_by_count,r.is_retweeted_by_count=o.is_retweeted_by_count}(e),i()}),h.bind("clickEdge",function(e){var t=e.data.edge;s.edge=t;for(var n={},i={mention:0,quote:0,retweet:0},r=0;r<t.outgoing_ids.length;++r){var a=t.tweet_types[r];"reply"==a&&(a="mention"),"origin"==a&&(a="mention"),++i[a],n[t.outgoing_ids[r]]=TWEET_URL.replace("%0",t.target).replace("%1",t.outgoing_ids[r])}s.tweet_urls=n;var c="",u=0;for(var d in i)i.hasOwnProperty(d)&&i[d]>0&&(0==u++?c+=" ":c+=", ","mention"==d?c+="mentioned":"retweet"==d?c+="was retweeted by":"quote"==d&&(c+="was quoted by"));s.label_string=c,o()})}function P(e){e=e||l.end_time;var t=[],n=h.graph.edges(),o=h.graph.nodes(),i={fact_checking:colors.edge_colors.fact_checking,claim:colors.edge_colors.claim},r={},s=0,a=0;for(var c in n){var u=n[c];0,u.min_tweet_created_at>=e?(0,u.color="rgba(0,0,0,.05)"):(r[u.target]=r[u.target]||0,r[u.source]=r[u.source]||0,r[u.target]+=1,r[u.source]+=1,u.color=i[u.edge_type],t.push(u.target),t.push(u.source))}for(var c in r)0,r[c]>s&&(s=r[c]),r[c]<a&&(a=r[c]);for(var c in o){var d,_=o[c];if(-1===t.indexOf(_.id))_.color="rgba(0,0,0,.05)",_.borderColor="rgba(0,0,0,.05)",(d=1e3*(Math.sqrt(a)/Math.sqrt(s))+1)<300&&(d=300),_.size=d;else(d=1e3*(Math.sqrt(r[_.id])/Math.sqrt(s))+1)<300&&(d=300),_.size=d,score=!1,v[_.id]&&(score=v[_.id].score),A(_.id,score)}T()}(function(e){sigma.canvas.nodes.border=function(e,t,n){var o=n("prefix")||"";t.fillStyle=e.color||n("defaultNodeColor"),t.beginPath(),t.arc(e[o+"x"],e[o+"y"],e[o+"size"],0,2*Math.PI,!0),t.closePath(),t.fill(),t.lineWidth=.5,t.strokeStyle=e.borderColor||C(!1),t.stroke()}}).call(this),d.playing=!1,d.paused=!1,d.increment=0;var E=0;function R(e){if(d.current_timestamp=e,P(e),e>l.end_time||d.increment>d.total_increments)return P((new Date).getTime()),d.increment=0,d.playing=!1,!1;var t=e+(l.end_time-l.start_time)/d.total_increments;E=setTimeout(function(){d.increment+=1,R(t)},120)}return t.filter=P,t.startAnimation=function(){console.debug(l),d.increment=1,d.playing=!0,d.paused=!1,R(l.start_time)},t.stopAnimation=function(){clearTimeout(E),d.current_timestamp>l.start_time&&P((new Date).getTime()),d.playing=!1,d.paused=!1},t.pauseAnimation=function(){clearTimeout(E),d.paused=!0},t.unpauseAnimation=function(){d.paused=!1,R(d.current_timestamp)},t.updateEdges=function(e){return 0===(p=e).length?(M(),p):p},t.updateGraph=function(e,t){if(clearTimeout(E),M(),!p||!p.length)throw"Tried to make graph, but there is no data.";var n={nodes:[],edges:[]},o=colors.node_colors,i={fact_checking:colors.edge_colors.fact_checking,claim:colors.edge_colors.claim},r={},s={};f=n,l.start_time=0,l.end_time=0;var a=0;try{for(var c in p){var u=p[c],d=u.from_user_id,_=u.to_user_id,g=u.tweet_id,h=u.tweet_type,w=u.is_mention,b=new Date(u.tweet_created_at).getTime();if(!(e&&b<e||t&&b>t)){(!l.start_time||b<l.start_time)&&(l.start_time=b),(!l.end_time||b>l.end_time)&&(l.end_time=b),e&&t&&(l.start_time=e,l.end_time=t);var y=u.url_raw,x=u.title;-1!=_&&(r[d]=r[d]||{id:"",size:1,color:"",incomingCount:0,outgoingCount:0,screenName:"",incoming:{},outgoing:{},edges:[]},r[d].id=d,r[d].size++,r[d].color=o[u.site_type],r[d].screenName=u.from_user_screen_name,r[d].edges.push("e"+c),r[d].outgoing[_]=r[d].outgoing[_]||{type:"",fact_checking:0,claim:0,screenName:"",count:0,min_tweet_created_at:(new Date).getTime(),max_tweet_created_at:0,is_mentions:[],tweet_types:[],ids:[],url_raws:[],titles:[]},r[d].outgoing[_][u.site_type]++,r[d].outgoing[_].type=r[d].outgoing[_].fact_checking>r[d].outgoing[_].claim?"fact_checking":"claim",r[d].outgoing[_].screenName=u.to_user_screen_name,r[d].outgoing[_].count++,r[d].outgoing[_].min_tweet_created_at=Math.min(b,r[d].outgoing[_].min_tweet_created_at),r[d].outgoing[_].max_tweet_created_at=Math.max(b,r[d].outgoing[_].max_tweet_created_at),r[d].outgoing[_].is_mentions.push(w),r[d].outgoing[_].tweet_types.push(h),r[d].outgoing[_].ids.push(g),r[d].outgoing[_].url_raws.push(y),r[d].outgoing[_].titles.push(x),r[d].outgoingCount++,r[_]=r[_]||{id:"",size:1,color:"",incomingCount:0,outgoingCount:0,screenName:"",incoming:{},outgoing:{},edges:[]},r[_].id=_,r[_].color=o[u.site_type],r[_].screenName=u.to_user_screen_name,r[_].edges.push("e"+c),r[_].incoming[d]=r[_].incoming[d]||{type:"",fact_checking:0,claim:0,screenName:"",count:0,is_mentions:[],tweet_types:[],ids:[],url_raws:[],titles:[]},r[_].incoming[d][u.site_type]++,r[_].incoming[d].type=r[_].incoming[d].fact_checking>r[_].incoming[d].claim?"fact_checking":"claim",r[_].incoming[d].screenName=u.from_user_screen_name,r[_].incoming[d].count++,r[_].incoming[d].is_mentions.push(w),r[_].incoming[d].tweet_types.push(h),r[_].incoming[d].ids.push(g),r[_].incoming[d].url_raws.push(y),r[_].incoming[d].titles.push(x),r[_].incomingCount++,s[d+" "+_]=s[d+" "+_]||0,s[d+" "+_]+=1,s[d+" "+_])}}var S=0,z=0;for(var c in a=0,r)a++,r[c].size>S&&(S=r[c].size),r[c].size<z&&(z=r[c].size);var A={},I=0;m.unavailable=0,m.old=0,m.found=0;var T=[],N=[],C=[],P=[];for(var c in m.user_list=[],r){var R=Math.sqrt(r[c].size)/Math.sqrt(S)*1e3+1;R<300&&(R=300);var B=v[r[c].id];B&&B.score?(-1===B.score?(C.push(r[c].id),m.unavailable+=1):!0===B.old?(N.push(r[c].id),m.old+=1,m.found+=1):(T.push(r[c].id),m.found+=1),B=B.score):(C.push(r[c].id),B=!1);var L,O,H=q(B);L=Math.cos(2*Math.PI*(I/a)),O=Math.sin(2*Math.PI*(I/a)),n.nodes.push({x:L,y:O,orig_size:r[c].size,size:R,label:r[c].screenName,id:c,node_id:I,color:H,data:r[c]}),A[c]=I,++I}var U=C.length;for(c=0;c<U;c++)P.push(C[c]);var D=N.length;for(c=0;c<D;c++)P.push(N[c]);for(m.current_index=T.length,c=0;c<m.current_index;c++)m.user_list.push(T[c]);for(toComputeLen=P.length,c=0;c<toComputeLen;c++)m.user_list.push(P[c]);a=n.nodes.length,m.total=a;var G=0;for(var c in r)for(var W in r[c].outgoing)n.edges.push({id:"e"+G,source:c,target:W,source_screenName:r[c].screenName,target_screenName:r[W].screenName,from_node_id:A[c],to_node_id:A[W],size:Number(r[c].outgoing[W].count),type:"arrow",edge_type:r[c].outgoing[W].type,color:i[r[c].outgoing[W].type],count:G,min_tweet_created_at:r[c].outgoing[W].min_tweet_created_at,max_tweet_created_at:r[c].outgoing[W].max_tweet_created_at,outgoing_ids:r[c].outgoing[W].ids,incoming_ids:r[W].incoming[c].ids,url_raws:r[c].outgoing[W].url_raws,titles:r[c].outgoing[W].titles,tweet_types:r[c].outgoing[W].tweet_types}),++G;n.edges.length}catch(e){console.debug(e)}return f=n,k(),f},t.getNewScores=function(){u.running=!0,x=20,function e(t){if(x<=0)return m.current_index=t,u.running=!1,!1;if(x-=1,t>=m.user_list.length)return console.debug(v),console.debug("end of list"),u.running=!1,!1;var n=m.user_list[t],o=h.graph.nodes(n),i=o.data.screenName,r={screen_name:i,user_id:n};v[n]&&(r.score=v[n].score,r.old=v[n].old);var s=new Promise(function(e,t){S(r).then(e,t)});return s.then(function(e){_.isReached="Error: rate limit reached"===e}),t++,setTimeout(function(){e(t)},1e3)}(m.current_index)},t.getBotCacheScores=function e(){if(void 0===f.nodes)return setTimeout(function(){e()},100),!1;for(var t in u.running=!0,m.user_list.length=0,w.length=0,p){var o=p[t];o.from_user_screen_name,o.to_user_screen_name,from_user_id=o.from_user_id,to_user_id=o.to_user_id,m.user_list.indexOf(from_user_id)<0&&m.user_list.push(from_user_id),m.user_list.indexOf(to_user_id)<0&&m.user_list.push(to_user_id),w.indexOf(from_user_id)<0&&w.push(from_user_id),w.indexOf(to_user_id)<0&&w.push(to_user_id)}var i=configuration.botcache_chunk_sizes;start_index=0,end_index=0;f.nodes.sort(function(e,t){return e.orig_size>t.orig_size?-1:e.orig_size<t.orig_size?1:0});var r=[];for(var t in f.nodes)r.push(f.nodes[t].id);for(t=0;t<i.length;t++){var s=i[t];start_index=end_index,end_index+=s;var a=r.slice(start_index,end_index);if(0===a.length)break;var c=axios({method:"post",url:configuration.botcache_url,responseType:"json",data:{user_id:a.join(",")}});c.then(function(e){n("getBotCacheScores"),console.debug("Got botcache: ",e.data);var t=e.data.result;for(var o in t){var i=t[o];if(i){var r=i.user.screen_name,s=i.user.id,a=0;a="en"==g||"en-gb"==g?i.scores.english:i.scores.universal,v[s]={score:a,old:!i.fresh,time:new Date(i.timestamp),user_id:i.user.id,screen_name:r},A(s,a)}}m.unavailable=0,m.old=0,m.found=0;var c=[],d=[],_=[],l=[];for(var o in m.user_list=[],f.nodes)(a=v[f.nodes[o].id])&&a.score?(-1===a.score?(_.push(f.nodes[o].id),m.unavailable+=1):!0===a.old?(d.push(f.nodes[o].id),m.old+=1,m.found+=1):(c.push(f.nodes[o].id),m.found+=1),a=a.score):(_.push(f.nodes[o].id),a=!1);var h=_.length;for(o=0;o<h;o++)l.push(_[o]);var p=d.length;for(o=0;o<p;o++)l.push(d[o]);for(m.current_index=c.length,o=0;o<m.current_index;o++)m.user_list.push(c[o]);for(toComputeLen=l.length,o=0;o<toComputeLen;o++)m.user_list.push(l[o]);m.total=f.nodes.length,u.running=!1},function(t){u.running=!1,console.warn("Botometer Scores Request Error: ",t);try{y<5&&(y+=1,e())}catch(e){console.warn(e)}n("getBotCacheScores")})}return c},t.getNodeColor=q,t.updateUserBotScore=S,t.zoomIn=function(){var e=h.camera;sigma.misc.animation.camera(e,{ratio:e.ratio/e.settings("zoomingRatio")},{duration:200}),e.goTo({ratio:e.ratio/e.settings("zoomingRatio")})},t.zoomOut=function(){var e=h.camera;sigma.misc.animation.camera(e,{ratio:e.ratio*e.settings("zoomingRatio")},{duration:200}),e.goTo({ratio:e.ratio*e.settings("zoomingRatio")})},t.redraw=function(){if(h&&h.camera){var e=h.camera;sigma.misc.animation.camera(e,{ratio:e.ratio},{}),e.goTo({ratio:e.ratio})}},t.getEdges=function(){return p},t.botscores=function(){return v},t.resetBotscores=function(){v={}},t.setLang=function(e){g=e},t.setBotScore=function(e,t){v[e]={score:t,user_id:e}},t.filterNodesByScore=function(e,t){var n=h.graph.nodes();for(var o in n){var i=n[o],r=!1;v[i.id]&&(r=v[i.id].score),e?!1!==r&&r>=t&&r<e?A(i.id,r):(i.color="rgba(0,0,0,.05)",i.borderColor="rgba(0,0,0,.05)"):A(i.id,r)}T()},t.score_stats=m,t.getRenderer=function(){return h.renderers[0]},t}